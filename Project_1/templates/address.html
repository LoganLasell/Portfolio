<!DOCTYPE html>
<html lang="en">
<head>
<title>TheBus: Address Search</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/static/styles.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body,h1,h2,h3,h4,h5,h6 {font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif}
  .w3-bar,h1,button {font-family: "Montserrat", sans-serif}
  .fa-anchor,.fa-coffee {font-size:200px}
  </style>


<div class="w3-bar w3-black w3-card w3-left-align w3-large">
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-yellow" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
    <a href="http://127.0.0.1:5000/" class="w3-bar-item w3-button w3-padding-large w3-white" style="height: 51px; overflow: visible;">
      <img src="{{ url_for('static', filename='thebus.png') }}" alt="Home" style="height: 40px; margin-top: -1px;">
    </a>
    <a href="http://127.0.0.1:5000/models" class="w3-bar-item w3-button w3-padding-large w3-white">Features</a>
    <a href="http://127.0.0.1:5000/about" class="w3-bar-item w3-button w3-padding-large w3-white">About</a>
    <a href="http://127.0.0.1:5000/contact" class="w3-bar-item w3-button w3-padding-large w3-white">Contact Us</a>
  </div>

<header id="addressHeader" class="text-center", style="background-color: #ebbd34; padding-top: 30px; padding-bottom: 30px;">
  <div>
    <h1 id="addressTop">Address Search</h1>
  </div>
</header>

<style>

  input {
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 20px;
  }

  .results, .arrivals {
    margin-top: 20px;
  }

  button {
    margin: 5px;
    padding: 10px 15px;
    background: #007BFF;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background: #0056b3;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007BFF;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }

  

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .center {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .button-item {
      display: inline-block;
      margin: 5px;
    }

</style>


  <body>

    <h2 class="address-info" style="background-color: white; padding-top: 40px; padding-bottom: 15px;">
      Enter an address to find buses nearby.
    </h2>
    
    <div id="searchBar" style="padding: 35px;">
      <form id="addressForm">
        <input type="text" id="addressInput" placeholder="Enter address..." />
        <button id="searchButton" type="submit">Search</button>
      </form>
    </div>
    
    <div id="results"></div>
    
    <div id="routesContainer" style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; align-items: stretch; max-width: 1200px; margin: 0 auto; padding: 20px;"></div>
    

    <div id="maps">
      <div  id="mapped" class="map-container">

      </div>
    </div>

    <div class="dropdownAddress">
      <select id="savedDropdown">
      </select>
    </div>

    <div class="delete-address-btn-container">
      <button id="deleteAddressBtn" style="display: none;">Delete Address</button>
      <button id="clearAllBtn">Clear All Saved Addresses</button>

    </div>

    <!-- Footer -->
  <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
    <p class="col-md-4 mb-0 text-body-secondary">Â© TheBus</p>

    <a href="http://127.0.0.1:5000/" class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
      <img src="static/thebus.png" alt="TheBus Logo" style="height: 40px;">
    </a>

    <ul class="nav col-md-4 justify-content-end">
      <li class="nav-item"><a href="http://127.0.0.1:5000/models" class="nav-link px-2 text-body-secondary">Features</a></li>
      <li class="nav-item"><a href="http://127.0.0.1:5000/about" class="nav-link px-2 text-body-secondary">About</a></li>
      <li class="nav-item"><a href="http://127.0.0.1:5000/contact" class="nav-link px-2 text-body-secondary">Contact Us</a></li>
    </ul>
  </footer>

    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
      const map = L.map('maps').setView([21.442843, -157.963486], 11);
      let marker = null;
      let stopMarkers = [];
      let markers = {};  // for buses

      const busIcon = L.icon({
        iconUrl: "/static/88ddb2f3138e79ff0ad212f5a6e14e23.png",  
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -32]
      });

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);


      // Search address
      const container = document.getElementById('routesContainer');
      let lastSearchAddress = '';
      const busStopsNearby = [];
      const busData = []

      document.getElementById('addressForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const address = document.getElementById('addressInput').value.trim();
        //console.log(address)
        if (!address) {
          alert('Please enter an address.');
          return;
        }

        const currentAddress = document.getElementById('addressInput').value.trim();  // trim to rid spaces
        //console.log(currentAddress)

        // If the address is changed, clear the previous results
        if (currentAddress != lastSearchAddress) {
            container.innerHTML = '';  // Clear previous results if it's a new address
            
        } else {
            console.log('Same address. Repopulating existing results...');
            container.innerHTML = '';  // Still clear results even if same address
          }



        try {
          // Geocode the address
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
          const data = await response.json();
          //console.log(data)

          if (data.length === 0) {
            throw new Error('No location found.');
          }

          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);

          // Move the map and marker
          map.setView([lat, lon], 17);

          if (marker) {
            marker.setLatLng([lat, lon]);
          } else {
            marker = L.marker([lat, lon]).addTo(map);
          }

          // Get nearby bus stops
          const busResponse = await fetch(`/routes?lat=${lat}&lng=${lon}`);
          const busData = await busResponse.json();
          //console.log(busData) //check to make sure stops received 

          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '';  // clear previous results


          if (busData.length === 0) {
            resultsDiv.innerHTML = '<p>No bus routes found near this address.</p>';
            return;
          }
          else{
            //console.log(busData)
            busStopsNearby.length = 0; // Clear old results before repopulating
            busData.forEach(busRoutes =>{
              busStopsNearby.push(busRoutes)
            });
            //console.log(busStopsNearby)
          }
      }
    
        catch {
          console.error("Something went wrong");
        }
        // Perform the search and populate buttons
        performSearch(currentAddress);

        // Update the last search address
        lastSearchAddress = currentAddress;
      });


      // Function for creating nearby bus stops
    function performSearch(address) {
      console.log(busStopsNearby)
        console.log(`Performing search for: ${address}`);

        busStopsNearby.forEach(route => { 
            const routeElement = document.createElement('div');
            routeElement.style.border = '1px solid #ccc';
            routeElement.style.padding = '16px';
            routeElement.style.borderRadius = '8px';
            routeElement.style.width = '200px';
            routeElement.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';

            routeElement.innerHTML = `
                <h3 style="margin-bottom: 8px;">${route.routeName}</h3>
                <p style="margin-bottom: 12px;">Arrival Time: ${'...'}</p>
                <button 
                    style="padding: 5px 10px; width: 100%;" 
                    onclick="focusOnBusStop(${route.stopLat}, ${route.stopLng})"
                >
                    Show Stop
                </button>
                <button id="save-address-btn;" style="padding: 5px 10px; width: 100%;"
                onclick="saveAddress(${route.stopLat}, ${route.stopLng})">
                Save Address
                </button>
            `;

            container.appendChild(routeElement);
    });
  }


      // Save Address
      function saveAddress(lat, lng) {
        let saved = JSON.parse(localStorage.getItem('savedAddresses')) || [];

        // Check for duplicates using .some and matching both lat/lng
        const exists = saved.some(addr => addr.lat === lat && addr.lng === lng);

        if (!exists) {
          saved.push({ lat, lng });
          localStorage.setItem('savedAddresses', JSON.stringify(saved));
        }
        // Send to routes.py
        fetch('/save-userAddress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lat, lng }) // send object, not string
        }).then(res => res.json())
          .then(data => console.log('Saved to backend:', data))
          .catch(err => console.error('POST failed:', err));

        // Update dropdown immediately
        updateSavedDropdown();
    }
        function deleteAddress(lat, lng) {
        let saved = JSON.parse(localStorage.getItem('savedAddresses')) || [];

        saved = saved.filter(addr => addr.lat !== lat || addr.lng !== lng);
        localStorage.setItem('savedAddresses', JSON.stringify(saved));


        fetch('/delete-userAddress', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lng }),
        })
          .then(res => res.json())
          .then(data => console.log('Deleted from backend:', data))
          .catch(err => console.error('DELETE failed:', err));

        updateSavedDropdown();
      }


      document.getElementById('clearAllBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete all saved addresses?')) {
          localStorage.removeItem('savedAddresses');
          updateSavedDropdown();
          document.getElementById('deleteAddressBtn').style.display = 'none';
        }
      });



      // This section updates the dropdown menu //
      async function updateSavedDropdown() {
        const dropdown = document.getElementById('savedDropdown');
        dropdown.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.text = 'Select a saved address';
        defaultOption.selected = true; // sets it as the default selection
        dropdown.appendChild(defaultOption);

        const saved = JSON.parse(localStorage.getItem('savedAddresses')) || [];
        const deduped = saved.filter(
          (item, index, self) =>
            index === self.findIndex(t => t.lat === item.lat && t.lng === item.lng)
        );


        if (deduped.length === 0) {
          const option = document.createElement('option');
          option.text = 'No saved addresses';
          option.disabled = true;
          dropdown.appendChild(option);
        } else {
          for (const location of deduped) {
            const { lat, lng } = location;  // pulls directly from location object
            const option = document.createElement('option');
            const address = await reverseGeocode(lat, lng);
            option.textContent = address;
            option.value = JSON.stringify({ lat, lng });  // store object as string in value
            dropdown.appendChild(option);
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        updateSavedDropdown();
      });

  
    document.getElementById('savedDropdown').addEventListener('change', () => {
      const selectedValue = document.getElementById('savedDropdown').value;
      const deleteBtn = document.getElementById('deleteAddressBtn');

      deleteBtn.style.display = selectedValue ? 'inline-block' : 'none';
    });

    // Deleting address using the delete button/function
    document.getElementById('deleteAddressBtn').addEventListener('click', () => {
      const dropdown = document.getElementById('savedDropdown');
      const selected = dropdown.value;

      if (!selected) return;

      const { lat, lng } = JSON.parse(selected); // extract from stored JSON

      deleteAddress(lat, lng); // call the server + local delete
      document.getElementById('deleteAddressBtn').style.display = 'none';
    });



      // Transform a lat-lng into human readable address
      async function reverseGeocode(lat, lng) {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        return data.display_name || `${lat}, ${lng}`;
      }



    // On webpage refresh tells browser not to update dropdown until all necessary dependencies have been rendered
      document.addEventListener('DOMContentLoaded', () => {
        updateSavedDropdown();
      });

      // Updates dropdown when address changed 
      document.getElementById('savedDropdown').addEventListener('change', (e) => {
        const selected = JSON.parse(e.target.value);  // safely parse the lat/lng
        const { lat, lng } = selected;

        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
          console.error('Invalid coordinates:', selected);
          return;
        }

        map.setView([lat, lng], 17);  
      });

      
      // Focuses in on searched bus stop
      function focusOnBusStop(lat, lng) {
        stopMarkers.forEach(m => map.removeLayer(m));
        stopMarkers = [];

        const stopMarker = L.marker([lat, lng], {icon: busIcon}).addTo(map);
        stopMarkers.push(stopMarker);

        map.setView([lat, lng], 17);

        const mapElement = document.getElementById('maps');
        mapElement.scrollIntoView({ behavior: 'smooth' });
      }

      async function displaySavedAddresses() {
        const saved = JSON.parse(localStorage.getItem('savedAddresses') || '[]');

        for (const pair of saved) {
          const [lat, lng] = pair.split(',');
          const address = await reverseGeocode(lat, lng);
          
          // For example, add it to a dropdown:
          const option = document.createElement('option');
          option.value = pair;
          option.textContent = address;
          document.getElementById('addressDropdown').appendChild(option);
        }
      }

     // Debugging check to verify geo-coded response success
      async function getGeoResponse(){
      const geoResponse = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${GOOGLE_MAPS_API_KEY}`);
      const geoData = await geoResponse.json();

      console.log('Raw geocode response:', geoData); // ðŸ‘ˆ NEW

      if (geoData.status !== "OK" || geoData.results.length === 0) {
        throw new Error('No location found.');
      }
      }
  </script>
  
  <footer>
      
  </footer>
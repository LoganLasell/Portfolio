<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheBus: Live Bus Tracker</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    
    <style>
        body,h1 {font-family: "Lato", sans-serif}
        .w3-bar,h1,button {font-family: "Montserrat", sans-serif}
        .fa-anchor,.fa-coffee {font-size:200px}

        
        </style>
</head>
<body>
    <div class="w3-bar w3-black w3-card w3-left-align w3-large">
        <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-yellow" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
        <a href="http://127.0.0.1:5000/" class="w3-bar-item w3-button w3-padding-large w3-white" style="height: 51px; overflow: visible;">
          <img src="{{ url_for('static', filename='thebus.png') }}" alt="Home" style="height: 40px; margin-top: -1px;">
        </a>
        <a href="http://127.0.0.1:5000/models" class="w3-bar-item w3-button w3-padding-large w3-white">Features</a>
        <a href="http://127.0.0.1:5000/about" class="w3-bar-item w3-button w3-padding-large w3-white">About</a>
        <a href="http://127.0.0.1:5000/contact" class="w3-bar-item w3-button w3-padding-large w3-white">Contact Us</a>
      </div>
      <header id="map-Bus"> </header>
  
    <h1 id="busTrackerTitle"> <center>Live Bus Tracker</center></h1>
      

    <div class="container">
        <div id="sidebar">
            <select id="busStopSelect">
            </select>
        </div>

        <div id="map"></div>
        
    </div>
 
    <!-- Footer -->
    <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
    <p class="col-md-4 mb-0 text-body-secondary">Â© TheBus</p>
  
    <a href="http://127.0.0.1:5000/" class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
      <img src="static/thebus.png" alt="TheBus Logo" style="height: 40px;">
    </a>
  
    <ul class="nav col-md-4 justify-content-end">
      <li class="nav-item"><a href="http://127.0.0.1:5000/models" class="nav-link px-2 text-body-secondary">Features</a></li>
      <li class="nav-item"><a href="http://127.0.0.1:5000/about" class="nav-link px-2 text-body-secondary">About</a></li>
      <li class="nav-item"><a href="http://127.0.0.1:5000/contact" class="nav-link px-2 text-body-secondary">Contact Us</a></li>
    </ul>
    </footer>
  

    <script>
        let map = L.map('map').setView([21.485, -157.995], 11);

        L.tileLayer('https://api.mapbox.com/styles/v1/quinndaniel11/clp0j258c00cn01of0uzodeg3/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoicXVpbm5kYW5pZWwxMSIsImEiOiJjbTd0djgzNG0yMDhoMmtwdnBxb3V3d3E4In0.aqOJFJsCFNI_cBcmZ46f7A', {
            attribution: '&copy; Mapbox',
            minZoom: 11,
            maxZoom: 19
        }).addTo(map);

        let markers = {};  // store markers by vehicle ID


        var busIcon = L.icon({
            iconUrl: "/static/88ddb2f3138e79ff0ad212f5a6e14e23.png",  
            iconSize: [32, 32],  // width and height in pixels
            iconAnchor: [16, 16],  // point of the icon that corresponds to the marker location (center bottom)
            popupAnchor: [0, -32]
        });

        function updateMap(data) {
            $.getJSON('/arrivals', function(data) {
                data.arrivals.forEach(arrival => {
                    let lat = parseFloat(arrival.latitude);
                    let lon = parseFloat(arrival.longitude);
                    let vehicle = arrival.vehicle;

                    if (!markers[vehicle]) {
                        // create new marker if it doesn't exist
                        let marker = L.marker([lat, lon], {icon: busIcon}).addTo(map)
                            .bindPopup(`Vehicle: ${vehicle}`);
                        markers[vehicle] = marker;
                    } else {
                        // update marker position
                        markers[vehicle].setLatLng([lat, lon]);
                    }
                });
            });
        }

        function findStop(userLat, userLon) {
            $.getJSON('stops.json', function(data) {
                data.entry.forEach(entry => {
                    let stopLat = parseFloat(entry.lat);
                    let stopLon = parseFloat(entry.lon);
                    let stopID = entry.id;
                    var from = [userLat, userLon];
                    var to = [stopLat, stopLon];
                    res = Math.min(res, from.distanceTo(to).toFixed(0)/1000);
                    
                })
            });
        }

        // 1. Get user's coordinates from localStorage
const userLat = parseFloat(localStorage.getItem('userLat'));
const userLon = parseFloat(localStorage.getItem('userLon'));

// 2. Fetch stops.json and process the data
fetch('/static/stops.json')  // Adjust the path if needed
    .then(response => response.json())
    .then(data => {
        //distance from user coords to each stop
        const stopsWithDistance = data.map(stop => {
            const stopLat = parseFloat(stop.lat);
            const stopLon = parseFloat(stop.lon);
            const distance = haversine(userLat, userLon, stopLat, stopLon); // in km
            return { ...stop, distance }; // append distance to stop obj
        });

        // sort stops by distance (closest first)
        stopsWithDistance.sort((a, b) => a.distance - b.distance);

        // select the 10 closest stops
        const closestStops = stopsWithDistance.slice(0, 10);
        localStorage.setItem("closestStops", JSON.stringify(closestStops));

        populateDropdown(closestStops);
    })
    .catch(error => console.error('Error loading bus stop data:', error));

    function haversine(lat1, lon1, lat2, lon2) {
        const toRad = angle => angle * Math.PI / 180;
        const R = 6371; // earth's radius in km
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return (R * c) * 0.621371; // in miles
}


function populateDropdown(closestStops) {
    const select = document.getElementById('busStopSelect');
    select.innerHTML = '';
    closestStops.forEach(stop => {
        const option = document.createElement('option');
        option.value = stop.id;
        option.textContent = `STOP: ${stop.id} - ${stop.distance.toFixed(2)} miles`;
        select.appendChild(option);
    });
}

document.getElementById('busStopSelect').addEventListener('change', function() {
    let selectedStopId = this.value;
    updateMapForStop(selectedStopId);
});

function updateMapForStop(stopId) {
    fetch(`/arrivals?stop=${stopId}`)
        .then(response => response.json())
        .then(data => {
            // Clear existing markers
            for (let vehicle in markers) {
                map.removeLayer(markers[vehicle]);
            }
            markers = {};
            // Add new markers
            data.arrivals.forEach(arrival => {
                let lat = parseFloat(arrival.latitude);
                let lon = parseFloat(arrival.longitude);
                let vehicle = arrival.vehicle;
                let marker = L.marker([lat, lon], {icon: busIcon}).addTo(map)
                    .bindPopup(`Vehicle: ${vehicle}`);
                markers[vehicle] = marker;
            });
        })
        .catch(error => console.error('Error fetching bus data:', error));
}

        setInterval(() => {
            fetch('/arrivals')  
            .then(response => response.json())
            .then(data => {
                console.log(data);  
                updateMap(data);
    })
        .catch(error => console.error('Fetch error:', error));
        }, 1000);

    </script>
</body>
</html>